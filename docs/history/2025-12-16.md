# 2025-12-16 Development Log

## Overview

モバイルパフォーマンスの徹底的な改善と、SEO 上のメタデータ不整合の修正を実施。
「不可視の最適化 (Invisible Optimization)」戦略を採用し、Partytown の導入によってサードパーティスクリプトの実行を Web Worker へオフロード。
これにより、サイトの豊かなビジュアル表現と体験を **一切損なうことなく**、モバイルスコア **93 点**、デスクトップスコア **100 点** を達成した。

## Completed Tasks

### 1. Deep Performance Optimization (Score 52 -> 93)

LCP (Largest Contentful Paint) の短縮 (19.1s -> 4.5s) と、TBT (Total Blocking Time) のほぼ完全な解消を実現。

- **Partytown Integration (Worker Offloading)**:
  - Google Analytics (`gtag.js`) の処理をメインスレッドから `Partytown` (Web Worker) へ委譲。
  - これにより、メインスレッドが UI 描画に専念できるようになり、初期表示時の操作不能時間が消滅。
- **Resource Optimization**:
  - **Fonts**: 未使用だった日本語フォント `M PLUS Rounded 1c` を削除（ペイロード削減 -1MB 以上）。
  - **Scripts**: AdSense 読み込み戦略を `afterInteractive` から `lazyOnload` へ変更し、LCP への干渉を排除。
  - **Next.js Config**: `optimizePackageImports` を有効化し、`framer-motion` や `@phosphor-icons/react` のバンドルサイズを最適化。
- **Mobile-Specific Rendering**:
  - `AmbientBackground.tsx`: モバイル端末のみ `blur-3xl` と `animate-pulse` を無効化し、GPU 負荷とバッテリー消費を大幅に低減。
  - Hero セクションの `mix-blend-difference` をモバイルで無効化し、合成レイヤーのコストを削減。

### 2. SEO & Metadata Fixes

- **Title Duplication Fix**: -動的ページ (`/[hex]`, `/result/[group]`, `/diagnosis/logic/*`) において、タイトル末尾に `| 24bitColors` が二重付与されていた問題を修正。
  - `layout.tsx` のテンプレート設定と個別ページの記述の衝突を解消。

## Technical Implementation Details

### Components

- `PartytownSetup.tsx`: Partytown の設定を行うクライアントコンポーネント。
- `GoogleAnalyticsPartytown.tsx`: Partytown 経由で GA タグを配信するカスタムコンポーネント。従来の `@next/third-parties/google` を置換。

### Configuration

- `package.json`: ビルド後に Partytown のライブラリファイルを `public/~partytown` にコピーする `postbuild` スクリプトを追加。
- `.gitignore`: 自動生成される `/public/~partytown` を管理対象外に追加。

## Outcome

- **Google PageSpeed Insights**:
  - **Mobile**: 93 / 100
  - **Desktop**: 100 / 100
- **User Experience**:
  - ページ遷移が体感できるレベルで高速化。
  - スクロールの引っ掛かりやカクつきが解消。
